# ADR（Architecture Decision Record）作成ガイド

このドキュメントは、Personal Data HubプロジェクトでADRを作成する際のガイドです。

## ADRとは

**ADR（Architecture Decision Record）** は、アーキテクチャ上の重要な決定を記録するドキュメントです。

### なぜADRが必要か

- **決定の背景を残す**: なぜその技術を選んだのか、後から振り返れる
- **判断の透明性**: 決定プロセスが明確になる
- **学習**: 過去の決定から学べる
- **変更の追跡**: 決定が変わった場合も履歴が残る

## いつADRを書くべきか

以下のような場合にADRを作成します：

### 技術選定
- フレームワーク、ライブラリの選定
- プログラミング言語の選択
- データベースの選定
- AWSサービスの選定

### アーキテクチャ決定
- システム構成の変更
- データモデルの設計
- APIの設計方針
- デプロイ戦略

### 開発プロセス
- テスト戦略
- コーディング規約
- ブランチ戦略
- リリースプロセス

### 判断基準

以下の質問に **YES** なら、ADRを作成すべきです：

- この決定は、後から変更するとコストが高いか？
- この決定は、他の開発者（未来の自分含む）が理解すべき重要な理由があるか？
- この決定は、複数の選択肢を比較検討した結果か？

## ADRの構成要素

ADRは以下のセクションで構成されます：

### 1. タイトル

```markdown
# ADR 001: プロジェクト概要と要件定義
```

- **番号**: 3桁のゼロパディング（001, 002, ...）
- **タイトル**: 決定内容を簡潔に表す

### 2. 日付

```markdown
## 日付
2025-10-19
```

ADRを作成した日付（YYYY-MM-DD形式）を記録します。

### 3. 関連ADR（置換する場合のみ）

```markdown
## 関連ADR
- ADR 001を置換（理由: コールドスタートが遅いため）
```

このADRが他のADRを置換する場合のみ記載します。置換されたADRは `docs/adr/superseded/` に移動します。

### 4. コンテキスト

```markdown
## コンテキスト

このADRで扱う問題や背景を記述します。

- なぜこの決定が必要なのか
- どのような課題があるのか
- どのような制約条件があるのか
```

決定の背景を説明します。読者がコンテキストを理解できるように書きます。

### 5. 決定事項

```markdown
## 決定事項

何を決定したのかを明確に記述します。
```

**良い例**:
- PostgreSQLをデータベースとして採用する
- Kotlinを採用する
- Vitestを単体テストフレームワークとして採用する

**悪い例**:
- データベースを検討する（決定していない）
- 良いフレームワークを使う（曖昧）

### 6. 選定理由

```markdown
## 選定理由

### 検討した選択肢
1. 選択肢A
2. 選択肢B

### 選定した理由
- 理由1
- 理由2
```

複数の選択肢を比較し、なぜこれを選んだのか説明します。

### 7. 影響

```markdown
## 影響

### ポジティブな影響
- 良い影響1

### ネガティブな影響
- 悪い影響1

### 対策
- 対策1
```

この決定がプロジェクトに与える影響を記述します。

### 8. 関連ドキュメント（任意）

```markdown
## 関連ドキュメント

- [開発ワークフロー](../development-workflow.md)
- [設計書](../design/xxx.md)
```

関連するドキュメントへのリンクを記載します。

### 9. 参考資料（任意）

```markdown
## 参考資料

- [公式ドキュメント](https://example.com)
- [GitHub Issue](https://github.com/owner/repo/issues/1)
```

決定の根拠となった外部リソースへのリンクを記載します。

## ADRの作成手順

### 1. 番号を決める

既存のADRを確認し、次の番号を決定します。

```bash
ls docs/adr/
# 001-xxx.md
# 002-xxx.md
# ...
# 008-xxx.md
# → 次は 009
```

### 2. ファイル名を決める

ファイル名の形式: `NNN-kebab-case-title.md`

**良い例**:
- `009-commit-type-feature-instead-of-feat.md`
- `010-use-supabase-for-database.md`

**悪い例**:
- `9-commit.md`（番号がゼロパディングされていない）
- `009-Commit_Type.md`（kebab-caseではない）

### 3. テンプレートをコピー

```bash
cp docs/templates/adr/adr-template.md docs/adr/009-your-title.md
```

### 4. 内容を記入

テンプレートの各セクションを埋めていきます。

### 5. レビュー

自己レビュー、または他の開発者にレビューを依頼します。

### 6. 決定を変更する場合

決定を変更する場合は、以下の手順で行います：

1. **新しいADRを作成**
   - 新しい番号で作成
   - 「関連ADR」セクションに置換するADRを記載
   - 変更点と変更理由を明記

2. **古いADRを移動**
   - 古いADRを `docs/adr/superseded/` ディレクトリに移動
   - ファイルの内容は変更しない

3. **関連ドキュメントのリンクを更新**（必要に応じて）
   - 他のドキュメントから古いADRへのリンクがあれば、新しいADRに更新

## ADRのライフサイクル

### ディレクトリ構造で状態を表現

```
docs/adr/
├── 001-use-spring-and-doma.md          # 有効なADR
├── 002-change-di-to-koin.md            # 有効なADR（001を置換）
└── superseded/
    └── 001-use-spring-and-doma.md      # 置換されたADR
```

### 状態管理の方針

- **有効なADR**: `docs/adr/` 直下に配置
- **置換されたADR**: `docs/adr/superseded/` に移動
- **ステータスフィールドは不要**: ディレクトリ位置が状態を表す
- **ADRファイルは不変**: 作成後は内容を変更せず、移動のみ

**用語について**: `superseded` はRFC（Request for Comments）でも使われる標準的な用語で、「より新しいものに置き換えられた」という意味です。

### 具体例

**ADR 002の内容**（ADR 001を置換する場合）:

```markdown
# ADR 002: DIフレームワークをSpringからKoinに変更

## 日付
2025-11-01

## 関連ADR
- ADR 001を置換（理由: Lambdaでのコールドスタートが遅いため）

## コンテキスト
ADR 001でDIにSpringを採用したが、Lambda環境でのコールドスタートが
平均5秒かかることが判明...

## 決定事項
DIフレームワークをKoinに変更する。
SQL操作はDomaのまま継続。

## 選定理由

### 変更点
- DI: Spring → Koin（変更）
- SQL: Doma → Doma（継続）

### 理由
- Koinは軽量で起動が速い
- コールドスタートが1秒以下に改善
...
```

**ADR 002作成時の操作**:

```bash
# 新しいADRを作成
vim docs/adr/002-change-di-to-koin.md

# 古いADRを移動
git mv docs/adr/001-use-spring-and-doma.md docs/adr/superseded/001-use-spring-and-doma.md
```

### メリット

1. **経緯の追跡が容易**
   - `docs/adr/` を見れば現在有効な決定が一目瞭然
   - `docs/adr/superseded/` で過去の変遷を確認できる
   - git logでファイル移動履歴も追跡可能

2. **ファイルの不変性**
   - ADRファイルは作成後、内容を変更しない
   - 複雑なステータス管理が不要
   - git履歴が汚れない

3. **変更の明確化**
   - 新しいADRに「何が変わったか」「なぜ変えたか」を記録
   - 差分が明確

## ADR作成のベストプラクティス

### 1. 簡潔に書く

- 長すぎる文章は避ける
- 箇条書きを活用する
- 1つのADRで1つの決定を扱う

### 2. 理由を明確にする

- 「なぜそれを選んだのか」を重視
- 選ばなかった選択肢も記載する
- トレードオフを明示する

### 3. 後から読んでもわかるように書く

- 背景知識のない人でも理解できるように
- 専門用語は説明を加える
- リンクを活用する

### 4. 早めに書く

- 決定した直後に書く（記憶が新鮮なうちに）
- 実装前に書くことで、レビューの材料になる

### 5. 更新を恐れない

- 決定が変わったら、新しいADRを作成する
- 古いADRは `superseded/` に移動する
- ADRファイル自体の内容は変更しない

## サブエージェント（Claude Code）

ADR作成を支援するサブエージェントを用意しています。

`.claude/agents/create-adr.md`

このエージェントを使用すると、Claudeが以下を自動で行います：

1. 既存ADRの番号を確認
2. 次の番号を提案
3. テンプレートから新しいADRを作成
4. 対話的に内容を記入（壁打ち）
5. 既存ADRのフォーマットに統一

## 参考資料

- [ADRテンプレート](templates/adr/adr-template.md)
- [既存のADR](adr/)
- [Architecture Decision Records (GitHub)](https://adr.github.io/)
- [Documenting Architecture Decisions](https://cognitect.com/blog/2011/11/15/documenting-architecture-decisions)

## 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2025-10-19 | 初版作成 |
